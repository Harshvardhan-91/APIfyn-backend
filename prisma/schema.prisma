generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id             String           @id @default(cuid())
  name           String           @unique
  description    String
  monthlyPrice   Float
  yearlyPrice    Float
  features       String[]
  apiCallsLimit  Int
  workflowsLimit Int
  type           SubscriptionTier @default(FREE)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  subscriptions  Subscription[]

  @@map("plans")
}

model Subscription {
  id                 String    @id @default(cuid())
  razorpaySubId      String?   @unique
  status             String
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  interval           String
  intervalCount      Int       @default(1)
  planId             String
  userId             String    @unique
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  payments           Payment[]
  plan               Plan      @relation(fields: [planId], references: [id])
  user               User      @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model Payment {
  id                String       @id @default(cuid())
  razorpayPaymentId String       @unique
  amount            Float
  currency          String       @default("INR")
  status            String
  orderType         String
  razorpayOrderId   String?
  razorpaySignature String?
  subscriptionId    String
  userId            String
  createdAt         DateTime     @default(now())
  metadata          Json?
  subscription      Subscription @relation(fields: [subscriptionId], references: [id])
  user              User         @relation(fields: [userId], references: [id])

  @@map("payments")
}

model User {
  id            String              @id @default(cuid())
  firebaseUid   String              @unique
  email         String              @unique
  displayName   String?
  photoURL      String?
  emailVerified Boolean             @default(false)
  firstName     String?
  lastName      String?
  company       String?
  jobTitle      String?
  apiCallsUsed  Int                 @default(0)
  workflowsUsed Int                 @default(0)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  lastLoginAt   DateTime?
  integrations  Integration[]
  payments      Payment[]
  subscription  Subscription?
  executions    WorkflowExecution[]
  workflows     Workflow[]

  @@map("users")
}

model Integration {
  id             String          @id @default(cuid())
  name           String          // e.g. "My GitHub Repo" or "Slack Workspace"
  type           IntegrationType // GITHUB / SLACK
  config         Json            // stores repo/channel IDs, webhook secret etc.
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Workflow {
  id             String              @id @default(cuid())
  name           String
  description    String?
  triggerType    TriggerType         // WEBHOOK for GitHub push
  triggerConfig  Json                // e.g. repo, eventType (push, PR)
  actionConfig   Json                // e.g. Slack channel, message template
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions     WorkflowExecution[]
}

model WorkflowExecution {
  id            String          @id @default(cuid())
  status        ExecutionStatus
  startedAt     DateTime        @default(now())
  completedAt   DateTime?
  inputData     Json?
  outputData    Json?
  errorMessage  String?
  workflowId    String
  userId        String
  workflow      Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum TriggerType {
  WEBHOOK
  MANUAL
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum IntegrationType {
  GITHUB
  SLACK
}